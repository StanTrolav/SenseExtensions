define(["jquery","underscore","qlik","ng!$q","ng!$http","./properties","./initialproperties","client.utils/state","objects.backend-api/field-api","./lib/js/extensionUtils","./lib/js/moment","./lib/js/daterangepicker","general.models/library/dimension","text!./lib/css/style.css","text!./lib/css/daterangepicker.css","text!./lib/partials/template.html","./lib/js/clTouch","./lib/js/onLastRepeatDirective"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){"use strict";function q(a){var b=k().utcOffset();return 86400*(a-25568)-b}function r(a,b){return k(q(a),"X").utc().format(b)}var s=window.location.pathname.substr(0,window.location.pathname.toLowerCase().lastIndexOf("/sense/app/"));return s&&"/"!=s.substr(0,1)&&(s="/"+s),n=n.replace(new RegExp("__VirtualProxyPrefix__","g"),s),j.addStyleToHeader(n),j.addStyleToHeader(o),{definition:f,initialProperties:g,snapshot:{canTakeSnapshot:!0},support:{"export":!0,exportData:!1},getDropFieldOptions:function(a,b,c,d){d()},getDropDimensionOptions:function(a,b,c,d){d()},getDropMeasureOptions:function(a,b,c,d){d()},resize:function(){this.$scope.sizeMode=a(document).width()<=this.$scope.resolutionBreakpoint?"SMALL":""},paint:function(b,c){this.$scope.sizeMode=a(document).width()<this.$scope.resolutionBreakpoint?"SMALL":"",this.$scope.setFields(c.kfLists),this.$scope.props=c.props,this.$scope.initSelectionsApplied||this.$scope.setInitSelections(),this.$scope.qId=c.qInfo.qId},template:p,controller:["$scope","$element","$timeout",function(d){var e=c.currApp();d.selections={field:"",swipe_idx_min:-1,swipe_idx_max:-1,values_to_select:[],selectionMode:""},d.$on("onRepeatLast",function(){a("[id^=daterangepicker-container-"+d.qId+"]").remove(),b.each(d.fields,function(b){if("DATERANGE"==b.type){var c="daterangepicker-container-"+d.qId+"-"+b.id,e="daterange-"+d.qId+"-"+b.id;0==a("#"+c).length&&a("body").append('<div id="'+c+'" class="bootstrap" style="position: absolute"></div>');var f=function(a,c){d.selectDateFromAndTo(b.field,a.format(b.dateFormat),c.format(b.dateFormat),!0)},g=b.dateToday,h=k(g).endOf("month").format(b.dateFormat)==k(g).format(b.dateFormat),i=h?[k(g).subtract(11,"month").startOf("month"),k(g).endOf("month")]:[k(g).subtract(12,"month").startOf("month"),k(g).subtract(1,"month").endOf("month")],j={showDropdowns:!0,ranges:{Yesterday:[k(g),k(g)],"Last 7 Days":[k(g).subtract(6,"days"),k(g)],"Last 14 Days":[k(g).subtract(13,"days"),k(g)],"Last 28 Days":[k(g).subtract(27,"days"),k(g)],"Month to Date":[k(g).startOf("month"),k(g)],"Last Month":[k(g).subtract(1,"month").startOf("month"),k(g).subtract(1,"month").endOf("month")],"Year to Date":[k(g).startOf("year"),k(g)],"Rolling 12 months":i},locale:{format:b.dateFormat},alwaysShowCalendars:!1,parentEl:"#"+c};null!=b.dateStart&&null!=b.dateEnd&&(j.startDate=b.dateStart,j.endDate=b.dateEnd),null!=b.dateMin&&null!=b.dateMax&&(j.minDate=b.dateMin,j.maxDate=b.dateMax),a("#"+e).daterangepicker(j,f),a("#"+c+" div").first().css("display","inline-flex")}})}),d.resolutionBreakpoint=1024,d.sizeMode="",d.fields=[],d.variables=[],d.willApplyInitSelections=!1,d.initSelectionsApplied=!1,d.sessionStorageId=d.$parent.layout.qExtendsId?d.$parent.layout.qExtendsId:d.$parent.layout.qInfo.qId,d.getClass=function(){return h.isInAnalysisMode()?"":"no-interactions"},d.setFields=function(a){var c=[];b.each(a,function(a,d){var e=a.qListObject.qDataPages[0]?a.qListObject.qDataPages[0].qMatrix:[];switch(a.listType){case"FIELD":c.push({field:a.qListObject.qDimensionInfo.qGroupFieldDefs[0],type:a.listType,id:d,visible:a.listVisible,initSelection:a.initSelection,initSelectionSeparator:a.initSelectionSeparatorComma?",":a.initSelectionSeparator,label:a.label,data:e});break;case"VARIABLE":for(var f=a.variableValues?a.variableValues.split(","):[],g=a.alternativeDimensions?a.alternativeDimensions.split(","):[],h=[],i=0;i<f.length;i++)h.push(f.length==g.length&&a.alternativeDim?{value:f[i],altDim:g[i]}:{value:f[i]});c.push({variable:a.variable,variableValue:a.variableValue,id:d,type:a.listType,visible:a.listVisible,initSelection:a.initSelection,label:a.label,data:h});break;case"FLAG":var h=[];b.each(e,function(a){var b=a[0].qText.replace(" ","-"),c=a;c.icon=s+"/Extensions/cl-HorizontalSelectionBar/lib/images/flags/"+b+".png",h.push(c)}),c.push({field:a.qListObject.qDimensionInfo.qGroupFieldDefs[0],type:a.listType,id:d,visible:a.listVisible,initSelection:a.initSelection,initSelectionSeparator:a.initSelectionSeparatorComma?",":a.initSelectionSeparator,label:a.label,data:h});break;case"DATERANGE":var j="",k=null,l=null,m=r(a.daterangeMinValue,a.dateFormat),n=r(a.daterangeMaxValue,a.dateFormat),o=r(a.dateFromInitSelectionValue,a.dateFormat),p=r(a.dateToInitSelectionValue,a.dateFormat),q=r(a.dateTodayValue,a.dateFormat),t=!1;a.qListObject.qDimensionInfo.qStateCounts.qSelected>0?(a.qListObject.qDimensionInfo.qStateCounts.qSelected<a.dateMaxValue-a.dateMinValue+1&&(t=!0),k=r(a.dateMinValue,a.dateFormat),l=r(a.dateMaxValue,a.dateFormat),j=r(a.dateMinValue,a.displayDateFormat)+" - "+r(a.dateMaxValue,a.displayDateFormat)):j="Select a date range",c.push({field:a.qListObject.qDimensionInfo.qGroupFieldDefs[0],type:a.listType,id:d,visible:a.listVisible,dateFromInitSelection:o,dateToInitSelection:p,dateFormat:a.dateFormat,displayDateFormat:a.displayDateFormat,displayText:j,isNotARange:t,dateStart:k,dateEnd:l,dateToday:q,dateMin:m,dateMax:n,label:a.label,dateFromVariable:a.dateFromVariable,dateToVariable:a.dateToVariable,data:e});break;default:this.$scope.fields[d]=null}}),d.fields=c},d.selectValue=function(a,b,c,e){a.ctrlKey?d.selectFieldValues(b,[d.getValue(c)],!1):d.selectFieldValues(b,[d.getValue(c)],e)},d.selectDateFromAndTo=function(a,b,c,d){a="="==a.substring(0,1)?a.substring(1,a.length):a,e.field(a).selectMatch(">="+b+"<="+c,d).then(function(){})},d.selectFieldValues=function(a,c,d){a="="==a.substring(0,1)?a.substring(1,a.length):a;var f=[];b.each(c,function(a){f.push(JSON.parse(a))}),e.field(a).selectValues(f,d).then(function(){})["catch"](function(){location.reload(!0)})},d.setVariable=function(a,b){e.variable.setStringValue(a,b).then(function(){})},d.getValue=function(a){return JSON.stringify(isNaN(a.qNum)?{qText:a.qText}:a.qNum)},d.showField=function(a){return a.visible&&!b.isEmpty(a.data)},d.changeAlternativeDimensions=function(a,b,c,d){e.getObject(d).then(function(d){var e=[{qOp:"replace",qPath:"qHyperCubeDef/qDimensions/0",qValue:JSON.stringify(b)},{qOp:"replace",qPath:"qHyperCubeDef/qLayoutExclude/qHyperCubeDef/qDimensions/"+c,qValue:JSON.stringify(a)}];d.clearSoftPatches(),d.applyPatches(e,!0)})},d.prepareAlternativeDimension=function(a){var f=c.navigation.getCurrentSheetId();e.getObject(f.sheetId).then(function(c){var f=[];b.each(c.layout.cells,function(a){"linechart"==a.type&&f.push(a.name)}),b.each(f,function(c){e.getObjectProperties(c).then(function(f){e.getObject(c).then(function(e){if(e.clearSoftPatches(),f.properties.qHyperCubeDef.qLayoutExclude.qHyperCubeDef.qDimensions&&f.properties.qHyperCubeDef.qLayoutExclude.qHyperCubeDef.qDimensions.length>0){var g=f.properties.qHyperCubeDef.qDimensions[0];b.each(f.properties.qHyperCubeDef.qLayoutExclude.qHyperCubeDef.qDimensions,function(b,e){b.qLibraryId?m.getProperties(b.qLibraryId).then(function(f){a==f.properties.qDim.title&&d.changeAlternativeDimensions(g,b,e,c)}):b.qDef.qFieldLabels[0]==a&&d.changeAlternativeDimensions(g,b,e,c)})}})})})})},d.checkInitSelections=function(){var a=JSON.parse(sessionStorage.getItem(d.sessionStorageId)),b=a?a.selectionApplied:!1;b&&"ON_SHEET"!=d.layout.props.initSelectionMode||(d.willApplyInitSelections=!0)},d.setInitSelections=function(){if(d.willApplyInitSelections){b.each(d.fields,function(a){if("VARIABLE"!=a.type&&"DATERANGE"!=a.type&&""!=a.initSelection){var c=["=","<",">"];if(c.indexOf(a.initSelection.substring(0,1))>-1)e.field(a.field).clear(),e.field(a.field).selectMatch(a.initSelection);else{var f=a.initSelection.split(a.initSelectionSeparator),g=[];b.each(f,function(a){g.push(isNaN(a)?'{"qText": "'+a+'"}':a)}),d.selectFieldValues(a.field,g,!1)}}"VARIABLE"==a.type&&""!=a.initSelection&&d.setVariable(a.variable,a.initSelection),"DATERANGE"==a.type&&""!=a.dateFromInitSelection&&""!=a.dateToInitSelection&&d.selectDateFromAndTo(a.field,a.dateFromInitSelection,a.dateToInitSelection,!0)});var a={selectionApplied:!0};sessionStorage.setItem(d.sessionStorageId,JSON.stringify(a))}d.initSelectionsApplied=!0,d.willApplyInitSelections=!1},d.checkInitSelections(),d.onActivate=function(){},d.onSwipeStart=function(b){var c=a(b.target),e=a(b.target).index(),f=c.attr("field");d.selections.swipe_idx_min=e,d.selections.swipe_idx_max=e,d.selections.field=f;var g=c.attr("datavalue");d.selections.selectionsMode=!c.hasClass("S"),"undefined"!=typeof g&&0!=g&&(d.selections.selectionsMode?(d.selections.values_to_select.push(g),c.removeClass("A X O"),c.addClass("S")):(d.selections.values_to_select.push(g),c.removeClass("S"),c.addClass("X")))},d.onSwipeUpdate=function(b){var c=a(b.originalEvent.target),e=c.attr("field");if(e==d.selections.field){var f=a(b.originalEvent.target).index(),g=d.selections.swipe_idx_min>f||d.selections.swipe_idx_max<f;if(g){d.selections.swipe_idx_min=d.selections.swipe_idx_min>f?f:d.selections.swipe_idx_min,d.selections.swipe_idx_max=d.selections.swipe_idx_max<f?f:d.selections.swipe_idx_max;var h=a(b.originalEvent.target.parentElement.children);h.slice(d.selections.swipe_idx_min,d.selections.swipe_idx_max+1).each(function(){var b=this;if(d.selections.selectionsMode){if(!a(b).hasClass("S")){var c=a(b).attr("datavalue");-1==d.selections.values_to_select.indexOf(c)&&"undefined"!=typeof c&&0!=c&&(d.selections.values_to_select.push(c),a(b).removeClass("A X O"),a(b).addClass("S"))}}else if(a(b).hasClass("S")){var c=a(b).attr("datavalue");-1==d.selections.values_to_select.indexOf(c)&&"undefined"!=typeof c&&0!=c&&(d.selections.values_to_select.push(c),a(b).removeClass("S"),a(b).addClass("X"))}})}}},d.onSwipeCancel=function(a){},d.onSwipe=function(){d.selections.swipe_idx_min=-1,d.selections.swipe_idx_max=-1,d.selections.values_to_select!=[]&&(d.selectFieldValues(d.selections.field,d.selections.values_to_select,!0),d.selections.values_to_select=[]),d.selections.field=""}}]}});